<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hex to Token</title>
  <style>
    :root{
      --bg: #FFFFFF;
      --text: #0A0A0A;
      --muted: #99A1AF;
      --subtle: #6A7282;
      --card: #F3F4F6;
      --line: #E5E7EB;
      --primary: #2B7FFF;
      --radius-app: 24px;
      --radius-card: 4px;
      --radius-chip: 6px;
      --shadow: 0px 20px 25px -5px rgba(0, 0, 0, 0.1), 0px 8px 10px -6px rgba(0, 0, 0, 0.1);
      --mono: ui-monospace, Menlo, Monaco, "SF Mono", "Roboto Mono", "Cascadia Mono", Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }

    *{ box-sizing: border-box; }
    html, body{
      margin:0; padding:0;
      width:400px; height:660px;
      background: transparent;
      font-family: var(--sans);
      color: var(--text);
    }

    .app{
      position: relative;
      width: 400px;
      height: 660px;
      background: var(--bg);
      border-radius: var(--radius-app);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .header{
      padding: 16px 16px 0 16px;
    }

    .title{
      font-weight: 700;
      font-size: 20px;
      line-height: 28px;
      letter-spacing: -0.449219px;
    }

    .main{
      padding: 12px 16px 0 16px;
      /* footer(81px) + top padding 고려해서 scroll 영역 잡기 */
      height: calc(660px - 28px - 16px - 12px - 81px);
      overflow: auto;
    }

    .section{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .section-title{
      font-weight: 700;
      font-size: 14px;
      line-height: 20px;
      letter-spacing: -0.150391px;
    }

    .form{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .row{
      display:flex;
      align-items:center;
      gap: 16px;
      min-height: 32px;
    }

    .label{
      width: 100px;
      font-weight: 400;
      font-size: 12px;
      line-height: 16px;
      color: var(--text);
    }

    select.select{
      width: 252px;
      height: 32px;
      border: 0;
      border-radius: var(--radius-card);
      background: var(--card);
      padding: 0 10px;
      font-size: 12px;
      outline: none;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--subtle) 50%),
        linear-gradient(135deg, var(--subtle) 50%, transparent 50%);
      background-position:
        calc(100% - 14px) calc(50% - 2px),
        calc(100% - 9px)  calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }
    select.select:focus{
      outline: 2px solid rgba(43,127,255,.25);
    }

    .segmented{
      width: 252px;
      height: 48px;
      padding: 8px 8px 0 8px;
      background: var(--card);
      border-radius: var(--radius-card);
      display:flex;
      gap: 8px;
    }
    .seg{
      flex:1;
      height: 32px;
      border-radius: var(--radius-card);
      border: 0;
      background: transparent;
      font-size: 12px;
      line-height: 16px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
    }
    .seg.on{
      background: var(--bg);
      box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1), 0px 1px 2px -1px rgba(0, 0, 0, 0.1);
      color: #000;
    }

    .check{
      display:flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      cursor: pointer;
    }
    .check input{
      width: 16px;
      height: 16px;
      border-radius: 4px;
      accent-color: #030213;
    }
    .check span{
      font-weight: 500;
      font-size: 12px;
      line-height: 16px;
    }

    .divider{
      margin: 14px 0;
      height: 1px;
      background: var(--line);
    }

    .colors{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .block{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .block-title{
      font-weight: 600;
      font-size: 12px;
      line-height: 16px;
    }

    .card{
      background: var(--card);
      border-radius: var(--radius-card);
      overflow: hidden;
      border: 1px solid transparent;
    }

    .list{
      display:flex;
      flex-direction:column;
    }

    .item{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 0 16px;
      height: 48px;
      border-bottom: 1px solid var(--line);
      cursor: default;
    }
    .item:last-child{ border-bottom: 0; }

    .chip{
      width: 22px;
      height: 22px;
      border: 2px solid var(--line);
      border-radius: var(--radius-chip);
      background: #000;
      flex: none;
    }

    .mono{
      font-family: var(--mono);
      font-weight: 700;
      font-size: 12px;
      line-height: 16px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rowText{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      flex: 1;
    }
    .hex{
      width: 64px;
      flex:none;
      text-transform: uppercase;
    }
    .count{
      font-family: var(--mono);
      font-weight: 700;
      font-size: 12px;
      color: var(--subtle);
      flex:none;
    }
    .token{
      min-width: 0;
      color: var(--text);
      opacity: .95;
    }
    .mutedHint{
      font-size: 12px;
      color: var(--subtle);
      margin-top: 4px;
    }

    .clickable{
      cursor: pointer;
    }
    .clickable:hover{
      background: rgba(255,255,255,.6);
    }
    .selected{
      outline: 2px solid rgba(43,127,255,.35);
      outline-offset: -2px;
    }

    .noMatchRowWrap{ display: flex; flex-direction: column; }
    .inlineCandidates{ background-color: #E7EBF2; }

    /* Suggestions panel */
    .suggestPanel{
      margin-top: 10px;
      padding: 10px;
      background: var(--card);
      border-radius: var(--radius-card);
      border: 1px solid transparent;
    }
    .suggestHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .suggestTitle{
      font-weight: 600;
      font-size: 12px;
      line-height: 16px;
    }
    .suggestTarget{
      font-family: var(--mono);
      font-weight: 700;
      font-size: 12px;
      color: var(--subtle);
      text-transform: uppercase;
      white-space: nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .swatch{
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      min-height: 58px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .swatch:hover{
      border-color: rgba(43,127,255,.4);
    }
    .swatch.sel{
      outline: 2px solid rgba(43,127,255,.45);
      outline-offset: 0;
    }
    .swatchTop{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .swatchChip{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: #000;
      flex:none;
    }
    .swatchHex{
      font-family: var(--mono);
      font-weight: 700;
      font-size: 11px;
      color: var(--text);
      text-transform: uppercase;
      white-space: nowrap;
    }
    .swatchName{
      font-size: 11px;
      font-weight: 600;
      color: var(--subtle);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .footer{
      position: absolute;
      left: 0;
      bottom: 0;
      width: 400px;
      height: 81px;
      padding: 17px 16px 0 16px;
      background: var(--bg);
      border-top: 1px solid var(--line);
      display:flex;
      gap: 12px;
    }

    .btn{
      flex: 1;
      height: 48px;
      border-radius: var(--radius-card);
      font-weight: 600;
      font-size: 14px;
      line-height: 20px;
      letter-spacing: -0.150391px;
      cursor: pointer;
    }
    .btn-outline{
      background: var(--bg);
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .btn-primary{
      background: var(--primary);
      border: 0;
      color: #fff;
    }
    .btn:disabled{
      opacity: .5;
      cursor: not-allowed;
    }

  </style>
</head>

<body>
  <div class="app">
    <header class="header">
      <div class="title">Hex to Token</div>
    </header>

    <main class="main">
      <section class="section">
        <div class="section-title">Settings</div>

        <div class="form">
          <div class="row">
            <div class="label">Collection</div>
            <select id="collection" class="select">
              <option value="Semantic">Semantic</option>
              <option value="Primitive">Primitive</option>
            </select>
          </div>

          <div class="row" style="align-items:flex-start;">
            <div class="label" style="padding-top:8px;">Mode</div>
            <div class="segmented" role="tablist" aria-label="Mode">
              <button id="modeLight" class="seg on" type="button">Light</button>
              <button id="modeDark" class="seg" type="button">Dark</button>
            </div>
          </div>

          <label class="check">
            <input id="useGroupFilters" type="checkbox" checked />
            <span>Use group filters (Color, Black only)</span>
          </label>
        </div>

      </section>

      <div class="divider"></div>

      <section class="section colors">
        <div class="section-title">Colors</div>

        <div class="block">
          <div class="block-title">Matched colors</div>
          <div class="card">
            <div id="matchedList" class="list">
              <div class="item">
                <div class="mono" style="color:var(--subtle);">Run Scan to see results</div>
              </div>
            </div>
          </div>
        </div>

        <div class="block">
          <div class="block-title">No match colors (click to see token candidates)</div>
          <div class="card">
            <div id="noMatchList" class="list">
              <div class="item">
                <div class="mono" style="color:var(--subtle);">Run Scan to see results</div>
              </div>
            </div>
          </div>

          <div id="suggestPanel" class="suggestPanel" style="display:none;" class="suggestPanel" style="display:none;">
            <div class="suggestHeader">
              <div class="suggestTitle">Token candidates</div>
              <div class="suggestTarget" id="suggestTarget">—</div>
            </div>
            <div id="suggestGrid" class="grid"></div>
            <div class="mutedHint" id="suggestHint" style="display:none;">
              Tip: choose a token and apply it with “Apply”.
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <button id="scanBtn" class="btn btn-outline" type="button">Scan</button>
      <button id="applyBtn" class="btn btn-primary" type="button">Apply</button>
    </footer>
  </div>

  <script>
    // ---------- state ----------
    const state = {
      mode: "Light",
      collection: "Semantic",
      useGroupFilters: true,
      matchedColors: [],   // [{hex,count,variableId,variableName}]
      noMatchColors: [],   // [{hex,count}]
      expandedNoMatchHex: null,   // which no-match row is expanded (accordion)
      suggestionsCache: {}, // { [hex]: [{ variableId, name, hex }] }
      loadingSuggestionsHex: null
    };

    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);

    function setMode(mode){
      state.mode = mode;
      $("modeLight").classList.toggle("on", mode === "Light");
      $("modeDark").classList.toggle("on", mode === "Dark");
    }

    function emptyRow(text){
      const row = document.createElement("div");
      row.className = "item";
      const t = document.createElement("div");
      t.className = "mono";
      t.style.color = "var(--subtle)";
      t.textContent = text;
      row.appendChild(t);
      return row;
    }

    function renderMatched(){
      const list = $("matchedList");
      list.innerHTML = "";
      if (!state.matchedColors.length){
        list.appendChild(emptyRow("No matched colors"));
        return;
      }

      for (const it of state.matchedColors){
        const row = document.createElement("div");
        row.className = "item";

        const chip = document.createElement("div");
        chip.className = "chip";
        chip.style.background = "#" + it.hex;

        const rowText = document.createElement("div");
        rowText.className = "rowText";

        const hex = document.createElement("div");
        hex.className = "mono hex";
        hex.textContent = it.hex.toUpperCase();

        const token = document.createElement("div");
        token.className = "mono token";
        token.textContent = (it.variableName ?? "—");

        rowText.appendChild(hex);
        rowText.appendChild(token);

        const count = document.createElement("div");
        count.className = "count";
        count.textContent = it.count > 1 ? `x${it.count}` : "";

        row.appendChild(chip);
        row.appendChild(rowText);
        row.appendChild(count);

        list.appendChild(row);
      }
    }

    function renderNoMatch(){
      const list = $("noMatchList");
      list.innerHTML = "";
      if (!state.noMatchColors.length){
        list.appendChild(emptyRow("No no-match colors"));
        return;
      }

      for (const it of state.noMatchColors){
        const wrap = document.createElement("div");
        wrap.className = "noMatchRowWrap";

        const row = document.createElement("div");
        row.className = "item clickable";
        if (state.expandedNoMatchHex === it.hex) row.classList.add("selected");

        const chip = document.createElement("div");
        chip.className = "chip";
        chip.style.background = "#" + it.hex;

        const rowText = document.createElement("div");
        rowText.className = "rowText";

        const hex = document.createElement("div");
        hex.className = "mono hex";
        hex.textContent = it.hex.toUpperCase();

        rowText.appendChild(hex);

        const count = document.createElement("div");
        count.className = "count";
        count.textContent = it.count > 1 ? `x${it.count}` : "";

        row.appendChild(chip);
        row.appendChild(rowText);
        row.appendChild(count);

        row.onclick = () => {
          if (state.expandedNoMatchHex === it.hex) {
            state.expandedNoMatchHex = null;
          } else {
            state.expandedNoMatchHex = it.hex;
            if (!state.suggestionsCache[it.hex]) {
              state.loadingSuggestionsHex = it.hex;
              parent.postMessage({
                pluginMessage: {
                  type: "getSuggestions",
                  hex: it.hex,
                  mode: state.mode,
                  collection: state.collection,
                  useGroupFilters: state.useGroupFilters
                }
              }, "*");
            }
          }
          renderNoMatch();
        };

        const inlineCandidates = document.createElement("div");
        inlineCandidates.className = "inlineCandidates";
        inlineCandidates.style.display = state.expandedNoMatchHex === it.hex ? "block" : "none";

        if (state.expandedNoMatchHex === it.hex) {
          if (state.loadingSuggestionsHex === it.hex && !state.suggestionsCache[it.hex]) {
            inlineCandidates.appendChild(emptyRow("Loading..."));
          } else if (state.suggestionsCache[it.hex]) {
            const items = state.suggestionsCache[it.hex];
            if (!items.length) {
              inlineCandidates.appendChild(emptyRow("No candidates found"));
            } else {
              for (const s of items) {
                const itemRow = document.createElement("div");
                itemRow.className = "item clickable";

                const itemChip = document.createElement("div");
                itemChip.className = "chip";
                itemChip.style.background = "#" + (s.hex || "000");

                const itemRowText = document.createElement("div");
                itemRowText.className = "rowText";

                const itemName = document.createElement("div");
                itemName.className = "mono token";
                itemName.textContent = s.name ?? "—";

                const itemHex = document.createElement("div");
                itemHex.className = "mono hex";
                itemHex.textContent = (s.hex || "").toUpperCase();

                itemRowText.appendChild(itemName);
                itemRowText.appendChild(itemHex);

                itemRow.appendChild(itemChip);
                itemRow.appendChild(itemRowText);

                itemRow.onclick = (e) => {
                  e.stopPropagation();
                  parent.postMessage({
                    pluginMessage: { type: "applyTokenToColor", hex: it.hex, variableId: s.variableId }
                  }, "*");
                };
                inlineCandidates.appendChild(itemRow);
              }
            }
          } else {
            inlineCandidates.appendChild(emptyRow("Loading..."));
          }
        }

        wrap.appendChild(row);
        wrap.appendChild(inlineCandidates);
        list.appendChild(wrap);
      }
    }

    function renderAll(){
      renderMatched();
      renderNoMatch();
    }

    // ---------- UI events ----------
    $("collection").addEventListener("change", (e) => {
      state.collection = e.target.value;
    });

    $("useGroupFilters").addEventListener("change", (e) => {
      state.useGroupFilters = e.target.checked;
    });

    $("modeLight").addEventListener("click", () => setMode("Light"));
    $("modeDark").addEventListener("click", () => setMode("Dark"));

    $("scanBtn").addEventListener("click", () => {
      parent.postMessage({
        pluginMessage: {
          type: "scan",
          mode: state.mode,
          collection: state.collection,
          useGroupFilters: state.useGroupFilters
        }
      }, "*");
    });

    $("applyBtn").addEventListener("click", () => {
      parent.postMessage({
        pluginMessage: { type: "apply" }
      }, "*");
    });

    // ---------- inbound from plugin ----------
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === "scanUI") {
        state.matchedColors = msg.matchedColors || [];
        state.noMatchColors = msg.noMatchColors || [];
        if (state.expandedNoMatchHex && !state.noMatchColors.some(x => x.hex === state.expandedNoMatchHex)) {
          state.expandedNoMatchHex = null;
        }
        renderAll();
        return;
      }

      if (msg.type === "suggestions") {
        // { type:"suggestions", hex:"FF5733", items:[{variableId,name,hex}, ...] }
        if (msg.hex != null) {
          state.suggestionsCache[msg.hex] = msg.items || [];
        }
        state.loadingSuggestionsHex = null;
        renderNoMatch();
        return;
      }

      if (msg.type === "toast") {
        // optional helper: { type:"toast", message:"..." }
        // Here we keep it simple (no toast UI).
        return;
      }
    };

    // initial mode
    setMode("Light");
  </script>
</body>
</html>
